# Simple Process Injection

## Description

An executable is provided. This executable injects code into some other process. The objective is to analyse the injected code and find the solution *key*.

## Solution

There are multiple [process injection techniques](http://www.codeproject.com/Articles/4610/Three-Ways-to-Inject-Your-Code-into-Another-Proces) using which a process can inject and execute code from another process on Windows platform. One of the most common technique involves:

* Open a [handle][1] to the target process.
* Allocate memory in the target process using [VirtualAllocEx][2].
* Write injected code in the newly allocated memory using [WriteProcessMemory][3].
* Execute injected code using [CreateRemoteThread][4].

If a given sample uses this method of process injection, then the injected code can be extracted from memory at the time it is being written to the target process.

We set a breakpoint in *kernel32!WriteProcessMemory*, when the breakpoint is triggered, we can identify the address and size of data being written to target process:

<center><img src='/images/pi_wpm.png'></img></center>

The content of the inject data indicates that a PE file is being injected into the remote process:

<center><img src='/images/pi_dump.png'></img></center>

At this point, all we need to do is to dump the content of memory from where code is being injected to the target process:

<center><img src='/images/pi_dump_file.png'></img></center>

The dumped file was found to be a valid PE (DLL) file. We can analyse this file in IDA pro to identify the solution:

<center><img src='/images/pi_ida_sol.png'></img></center>

## Automated Extraction using HiDump

The process for manual extraction of injected code described above is automated in [HiDump](https://github.com/abhisek/RandomCode/tree/master/Malware/HiDump) tool. This tool can be used to extract injected code through dynamic anaysis:

<center><img src='/images/pi_hidump.png'></img></center>


[1]: https://msdn.microsoft.com/en-us/library/windows/desktop/ms724457(v=vs.85).aspx
[2]: https://msdn.microsoft.com/en-us/library/windows/desktop/aa366890(v=vs.85).aspx
[3]: https://msdn.microsoft.com/en-us/library/windows/desktop/ms681674(v=vs.85).aspx
[4]: https://msdn.microsoft.com/en-us/library/windows/desktop/ms682437(v=vs.85).aspx

