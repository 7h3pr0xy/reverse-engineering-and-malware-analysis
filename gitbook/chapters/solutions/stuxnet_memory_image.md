# Stuxnet Infected Memory Dump Analysis

## Description

A memory image of a live system infected with Stuxnet malware is provided. The objective is to analyse and identify IOC.

## Solution

We start by identifying a suitable profile for the memory image:

```bash
$ vol.py -f stuxnet.vmem imageinfo
Volatility Foundation Volatility Framework 2.5
INFO    : volatility.debug    : Determining profile based on KDBG search...
          Suggested Profile(s) : WinXPSP2x86, WinXPSP3x86 (Instantiated with WinXPSP2x86)
                     AS Layer1 : IA32PagedMemoryPae (Kernel AS)
                     AS Layer2 : FileAddressSpace (/Volumes/SSD1/REMA/Memory Images/stuxnet.vmem)
                      PAE type : PAE
                           DTB : 0x319000L
                          KDBG : 0x80545ae0L
          Number of Processors : 1
     Image Type (Service Pack) : 3
                KPCR for CPU 0 : 0xffdff000L
             KUSER_SHARED_DATA : 0xffdf0000L
           Image date and time : 2011-06-03 04:31:36 UTC+0000
     Image local date and time : 2011-06-03 00:31:36 -0400
```

We then try to identify possible connections to any command and control infrastructure:

```bash
$ vol.py -f stuxnet.vmem connections
Volatility Foundation Volatility Framework 2.5
Offset(V)  Local Address             Remote Address            Pid
---------- ------------------------- ------------------------- ---
$ vol.py -f stuxnet.vmem connscan
Volatility Foundation Volatility Framework 2.5
Offset(P)  Local Address             Remote Address            Pid
---------- ------------------------- ------------------------- ---
```

We then enumerate the processes looking for a possibly malicious process:

```bash
$ vol.py -f stuxnet.vmem pslist
Volatility Foundation Volatility Framework 2.5
Offset(V)  Name                    PID   PPID   Thds     Hnds   Sess  Wow64 Start                          Exit                          
---------- -------------------- ------ ------ ------ -------- ------ ------ ------------------------------ ------------------------------
0x823c8830 System                    4      0     59      403 ------      0                                                              
0x820df020 smss.exe                376      4      3       19 ------      0 2010-10-29 17:08:53 UTC+0000                                 
0x821a2da0 csrss.exe               600    376     11      395      0      0 2010-10-29 17:08:54 UTC+0000                                 
0x81da5650 winlogon.exe            624    376     19      570      0      0 2010-10-29 17:08:54 UTC+0000                                 
0x82073020 services.exe            668    624     21      431      0      0 2010-10-29 17:08:54 UTC+0000                                 
0x81e70020 lsass.exe               680    624     19      342      0      0 2010-10-29 17:08:54 UTC+0000                                 
0x823315d8 vmacthlp.exe            844    668      1       25      0      0 2010-10-29 17:08:55 UTC+0000                                 
0x81db8da0 svchost.exe             856    668     17      193      0      0 2010-10-29 17:08:55 UTC+0000                                 
0x81e61da0 svchost.exe             940    668     13      312      0      0 2010-10-29 17:08:55 UTC+0000                                 
0x822843e8 svchost.exe            1032    668     61     1169      0      0 2010-10-29 17:08:55 UTC+0000                                 
0x81e18b28 svchost.exe            1080    668      5       80      0      0 2010-10-29 17:08:55 UTC+0000                                 
0x81ff7020 svchost.exe            1200    668     14      197      0      0 2010-10-29 17:08:55 UTC+0000                                 
0x81fee8b0 spoolsv.exe            1412    668     10      118      0      0 2010-10-29 17:08:56 UTC+0000                                 
0x81e0eda0 jqs.exe                1580    668      5      148      0      0 2010-10-29 17:09:05 UTC+0000                                 
0x81fe52d0 vmtoolsd.exe           1664    668      5      284      0      0 2010-10-29 17:09:05 UTC+0000                                 
0x821a0568 VMUpgradeHelper        1816    668      3       96      0      0 2010-10-29 17:09:08 UTC+0000                                 
0x8205ada0 alg.exe                 188    668      6      107      0      0 2010-10-29 17:09:09 UTC+0000                                 
0x820ec7e8 explorer.exe           1196   1728     16      582      0      0 2010-10-29 17:11:49 UTC+0000                                 
0x820ecc10 wscntfy.exe            2040   1032      1       28      0      0 2010-10-29 17:11:49 UTC+0000                                 
0x81e86978 TSVNCache.exe           324   1196      7       54      0      0 2010-10-29 17:11:49 UTC+0000                                 
0x81fc5da0 VMwareTray.exe         1912   1196      1       50      0      0 2010-10-29 17:11:50 UTC+0000                                 
0x81e6b660 VMwareUser.exe         1356   1196      9      251      0      0 2010-10-29 17:11:50 UTC+0000                                 
0x8210d478 jusched.exe            1712   1196      1       26      0      0 2010-10-29 17:11:50 UTC+0000                                 
0x82279998 imapi.exe               756    668      4      116      0      0 2010-10-29 17:11:54 UTC+0000                                 
0x822b9a10 wuauclt.exe             976   1032      3      133      0      0 2010-10-29 17:12:03 UTC+0000                                 
0x81c543a0 Procmon.exe             660   1196     13      189      0      0 2011-06-03 04:25:56 UTC+0000                                 
0x81fa5390 wmiprvse.exe           1872    856      5      134      0      0 2011-06-03 04:25:58 UTC+0000                                 
0x81c498c8 lsass.exe               868    668      2       23      0      0 2011-06-03 04:26:55 UTC+0000                                 
0x81c47c00 lsass.exe              1928    668      4       65      0      0 2011-06-03 04:26:55 UTC+0000                                 
0x81c0cda0 cmd.exe                 968   1664      0 --------      0      0 2011-06-03 04:31:35 UTC+0000   2011-06-03 04:31:36 UTC+0000  
0x81f14938 ipconfig.exe            304    968      0 --------      0      0 2011-06-03 04:31:35 UTC+0000   2011-06-03 04:31:36 UTC+0000 
```

We identify that an additiona *lsass.exe* process is running in the system. We can use the *pstree* command to identify parent-child relation for processes:

```bash
$ vol.py -f stuxnet.vmem pstree
Volatility Foundation Volatility Framework 2.5
Name                                                  Pid   PPid   Thds   Hnds Time
-------------------------------------------------- ------ ------ ------ ------ ----
 0x823c8830:System                                      4      0     59    403 1970-01-01 00:00:00 UTC+0000
. 0x820df020:smss.exe                                 376      4      3     19 2010-10-29 17:08:53 UTC+0000
.. 0x821a2da0:csrss.exe                               600    376     11    395 2010-10-29 17:08:54 UTC+0000
.. 0x81da5650:winlogon.exe                            624    376     19    570 2010-10-29 17:08:54 UTC+0000
... 0x82073020:services.exe                           668    624     21    431 2010-10-29 17:08:54 UTC+0000
.... 0x81fe52d0:vmtoolsd.exe                         1664    668      5    284 2010-10-29 17:09:05 UTC+0000
..... 0x81c0cda0:cmd.exe                              968   1664      0 ------ 2011-06-03 04:31:35 UTC+0000
...... 0x81f14938:ipconfig.exe                        304    968      0 ------ 2011-06-03 04:31:35 UTC+0000
.... 0x822843e8:svchost.exe                          1032    668     61   1169 2010-10-29 17:08:55 UTC+0000
..... 0x822b9a10:wuauclt.exe                          976   1032      3    133 2010-10-29 17:12:03 UTC+0000
..... 0x820ecc10:wscntfy.exe                         2040   1032      1     28 2010-10-29 17:11:49 UTC+0000
.... 0x81e61da0:svchost.exe                           940    668     13    312 2010-10-29 17:08:55 UTC+0000
.... 0x81db8da0:svchost.exe                           856    668     17    193 2010-10-29 17:08:55 UTC+0000
..... 0x81fa5390:wmiprvse.exe                        1872    856      5    134 2011-06-03 04:25:58 UTC+0000
.... 0x821a0568:VMUpgradeHelper                      1816    668      3     96 2010-10-29 17:09:08 UTC+0000
.... 0x81fee8b0:spoolsv.exe                          1412    668     10    118 2010-10-29 17:08:56 UTC+0000
.... 0x81ff7020:svchost.exe                          1200    668     14    197 2010-10-29 17:08:55 UTC+0000
.... 0x81c47c00:lsass.exe                            1928    668      4     65 2011-06-03 04:26:55 UTC+0000
.... 0x81e18b28:svchost.exe                          1080    668      5     80 2010-10-29 17:08:55 UTC+0000
.... 0x8205ada0:alg.exe                               188    668      6    107 2010-10-29 17:09:09 UTC+0000
.... 0x823315d8:vmacthlp.exe                          844    668      1     25 2010-10-29 17:08:55 UTC+0000
.... 0x81e0eda0:jqs.exe                              1580    668      5    148 2010-10-29 17:09:05 UTC+0000
.... 0x81c498c8:lsass.exe                             868    668      2     23 2011-06-03 04:26:55 UTC+0000
.... 0x82279998:imapi.exe                             756    668      4    116 2010-10-29 17:11:54 UTC+0000
... 0x81e70020:lsass.exe                              680    624     19    342 2010-10-29 17:08:54 UTC+0000
 0x820ec7e8:explorer.exe                             1196   1728     16    582 2010-10-29 17:11:49 UTC+0000
. 0x81c543a0:Procmon.exe                              660   1196     13    189 2011-06-03 04:25:56 UTC+0000
. 0x81e86978:TSVNCache.exe                            324   1196      7     54 2010-10-29 17:11:49 UTC+0000
. 0x81e6b660:VMwareUser.exe                          1356   1196      9    251 2010-10-29 17:11:50 UTC+0000
. 0x8210d478:jusched.exe                             1712   1196      1     26 2010-10-29 17:11:50 UTC+0000
. 0x81fc5da0:VMwareTray.exe                          1912   1196      1     50 2010-10-29 17:11:50 UTC+0000
```

It appears there are 2 *lsass.exe* started by *services.exe* while normally it should be a single instance. We then look for possibly injected code in these *lsass.exe* process:

```bash
$ vol.py -f stuxnet.vmem malfind -p 1928 -D ./dump/
Volatility Foundation Volatility Framework 2.5
Process: lsass.exe Pid: 1928 Address: 0x80000
Vad Tag: Vad  Protection: PAGE_EXECUTE_READWRITE
Flags: Protection: 6

$ file dump/*
dump/process.0x81c47c00.0x1000000.dmp: PE32 executable for MS Windows (GUI) Intel 80386 32-bit
dump/process.0x81c47c00.0x680000.dmp:  data
dump/process.0x81c47c00.0x6f0000.dmp:  data
dump/process.0x81c47c00.0x80000.dmp:   PE32 executable for MS Windows (DLL) (GUI) Intel 80386 32-bit
dump/process.0x81c47c00.0x870000.dmp:  PE32 executable for MS Windows (DLL) (GUI) Intel 80386 32-bit
```

The *malfind* plugin dumps multiple possible malicious code injected into *lsass.exe* process with PID *1928*. One of the injected module was found to be malicious:

<center><img src='../../images/stuxnet_VT.png'></img></center>

### Kernel Rootkit Identification

The [Stuxnet](https://en.wikipedia.org/wiki/Stuxnet) worm is known to employ multiple kernel drivers in order to hide its presence. To detect such malicious drivers, we first enumerate the SSDT to look for possible system call hooks:

```bash
$ vol.py -f stuxnet.vmem ssdt | grep -v ntoskrnl.exe | grep -v win32k.sys
Volatility Foundation Volatility Framework 2.5
[x86] Gathering all referenced SSDTs from KTHREADs...
Finding appropriate address space for tables...
SSDT[0] at 80501b8c with 284 entries
  Entry 0x0019: 0xb240f80e (NtClose) owned by PROCMON20.SYS
  Entry 0x0029: 0xb240f604 (NtCreateKey) owned by PROCMON20.SYS
  Entry 0x003f: 0xb240f4ac (NtDeleteKey) owned by PROCMON20.SYS
  Entry 0x0041: 0xb240f4f2 (NtDeleteValueKey) owned by PROCMON20.SYS
  Entry 0x0047: 0xb240f3f2 (NtEnumerateKey) owned by PROCMON20.SYS
  Entry 0x0049: 0xb240f34e (NtEnumerateValueKey) owned by PROCMON20.SYS
  Entry 0x004f: 0xb240f446 (NtFlushKey) owned by PROCMON20.SYS
  Entry 0x0062: 0xb240f972 (NtLoadKey) owned by PROCMON20.SYS
  Entry 0x0077: 0xb240f7d0 (NtOpenKey) owned by PROCMON20.SYS
  Entry 0x00a0: 0xb240f03e (NtQueryKey) owned by PROCMON20.SYS
  Entry 0x00b1: 0xb240f166 (NtQueryValueKey) owned by PROCMON20.SYS
  Entry 0x00f7: 0xb240f28a (NtSetValueKey) owned by PROCMON20.SYS
  Entry 0x0107: 0xb240fac2 (NtUnloadKey) owned by PROCMON20.SYS
SSDT[1] at bf999b80 with 667 entries
```

We identify SSDT hooking however the hook functions appears to be belong to *PROCMON20.SYS* driver which is part of [Procmon](https://technet.microsoft.com/en-us/sysinternals/processmonitor.aspx) tool.

We then look for another vector through kernel functions can be intercepted for malicious activity by rootkits:

```bash
$ vol.py -f stuxnet.vmem callbacks
[...]
IoRegisterFsRegistrationChange       0xb21d89ec mrxnet.sys           -
GenericKernelCallback                0xf895ad06 mrxcls.sys           -
PsSetLoadImageNotifyRoutine          0xf895ad06 mrxcls.sys           -
[...]
```

After manual analysis of results, the above modules were found to be non-standard and possibly malicious. We can verify by dumping them to disk:

```bash
$ vol.py -f stuxnet.vmem modules | grep mrx
Volatility Foundation Volatility Framework 2.5
0x81f8cb60 mrxcls.sys           0xf895a000     0x5000 \??\C:\WINDOWS\system32\Drivers\mrxcls.sys
0x81c2a530 mrxnet.sys           0xb21d8000     0x3000 \??\C:\WINDOWS\system32\Drivers\mrxnet.sys
```

```bash
$ vol.py -f stuxnet.vmem moddump -b 0xf895a000 -D ./dump/
Volatility Foundation Volatility Framework 2.5
Module Base Module Name          Result
----------- -------------------- ------
0x0f895a000 mrxcls.sys           OK: driver.f895a000.sys
$ vol.py -f stuxnet.vmem moddump -b 0xb21d8000 -D ./dump/
Volatility Foundation Volatility Framework 2.5
Module Base Module Name          Result
----------- -------------------- ------
0x0b21d8000 mrxnet.sys           OK: driver.b21d8000.sys

$ file dump/*
dump/driver.b21d8000.sys: PE32 executable for MS Windows (native) Intel 80386 32-bit
dump/driver.f895a000.sys: PE32 executable for MS Windows (native) Intel 80386 32-bit
```

Online virus scan confirms that the extracted drivers are indeed malicious.

<center><img src='../../images/stuxnet_Driver.png'></img></center>
