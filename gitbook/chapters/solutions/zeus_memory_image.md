# Zeus Infected Memory Dump Analysis

## Description

A live memory image from a system assumed to be infected with [Zeus](https://en.wikipedia.org/wiki/Zeus_(malware)) malware is provided for inspection and [IOC](https://en.wikipedia.org/wiki/Indicator_of_compromise) identification.

## Solution

We start by identifying a suitable profile for the given image.

```bash
$ vol.py -f zeus.vmem imageinfo
Volatility Foundation Volatility Framework 2.5
INFO    : volatility.debug    : Determining profile based on KDBG search...
          Suggested Profile(s) : WinXPSP2x86, WinXPSP3x86 (Instantiated with WinXPSP2x86)
                     AS Layer1 : IA32PagedMemoryPae (Kernel AS)
                     AS Layer2 : FileAddressSpace (/Volumes/SSD1/REMA/Memory Images/zeus.vmem)
                      PAE type : PAE
                           DTB : 0x319000L
                          KDBG : 0x80544ce0L
          Number of Processors : 1
     Image Type (Service Pack) : 2
                KPCR for CPU 0 : 0xffdff000L
             KUSER_SHARED_DATA : 0xffdf0000L
           Image date and time : 2010-08-15 19:17:56 UTC+0000
     Image local date and time : 2010-08-15 15:17:56 -0400
```

We then look for probably connections to the [Command and Control]() infrastructure being made by the malicious executable:

```bash
$ vol.py -f zeus.vmem connscan
Volatility Foundation Volatility Framework 2.5
Offset(P)  Local Address             Remote Address            Pid
---------- ------------------------- ------------------------- ---
0x02214988 172.16.176.143:1054       193.104.41.75:80          856
0x06015ab0 0.0.0.0:1056              193.104.41.75:80          856

```

Here we identify that a process with PID:*856* has made connections to *193.104.41.75*

We enumerate processes to identify which process has our identified PID:

```bash
$ vol.py -f zeus.vmem pslist | grep 856
Volatility Foundation Volatility Framework 2.5
0x80ff88d8 svchost.exe             856    676     29      336      0      0 2010-08-11 06:06:24 UTC+0000   
```

While *svchost.exe* is known to be a core Windows service, malware may fake such names for its own executable. To identify if this svchost.exe is indeed the malicious executable, we look for its parent process:

```bash
$ vol.py -f zeus.vmem pstree
Volatility Foundation Volatility Framework 2.5
Name                                                  Pid   PPid   Thds   Hnds Time
-------------------------------------------------- ------ ------ ------ ------ ----
 0x810b1660:System                                      4      0     58    379 1970-01-01 00:00:00 UTC+0000
. 0xff2ab020:smss.exe                                 544      4      3     21 2010-08-11 06:06:21 UTC+0000
.. 0xff1ec978:winlogon.exe                            632    544     24    536 2010-08-11 06:06:23 UTC+0000
... 0xff255020:lsass.exe                              688    632     21    405 2010-08-11 06:06:24 UTC+0000
... 0xff247020:services.exe                           676    632     16    288 2010-08-11 06:06:24 UTC+0000
.... 0xff1b8b28:vmtoolsd.exe                         1668    676      5    225 2010-08-11 06:06:35 UTC+0000
..... 0xff224020:cmd.exe                              124   1668      0 ------ 2010-08-15 19:17:55 UTC+0000
.... 0x80ff88d8:svchost.exe                           856    676     29    336 2010-08-11 06:06:24 UTC+0000
```

The *svchost.exe* process with PID *856* appears to be the Windows service as it is started by *services.exe* during boot. This indicates that malicious code may have been injected into *svchost.exe* since we have already found evidence of it connecting to unknown IP address.

We can identify possibly hooked APIs in *svchost.exe*:

```bash
$ vol.py -f zeus.vmem --profile=WinXPSP2x86 -p 856 apihooks
Volatility Foundation Volatility Framework 2.5
************************************************************************
Hook mode: Usermode
Hook type: Inline/Trampoline
Process: 856 (svchost.exe)
Victim module: ntdll.dll (0x7c900000 - 0x7c9b0000)
Function: ntdll.dll!NtCreateThread at 0x7c90d7d2
Hook address: 0xb73b47
Hooking module: <unknown>

Disassembly(0):
0x7c90d7d2 e970632684       JMP 0xb73b47
0x7c90d7d7 ba0003fe7f       MOV EDX, 0x7ffe0300
0x7c90d7dc ff12             CALL DWORD [EDX]
0x7c90d7de c22000           RET 0x20
0x7c90d7e1 90               NOP
0x7c90d7e2 90               NOP
0x7c90d7e3 90               NOP
0x7c90d7e4 90               NOP
0x7c90d7e5 90               NOP
0x7c90d7e6 90               NOP
0x7c90d7e7 b8               DB 0xb8
0x7c90d7e8 36               DB 0x36
0x7c90d7e9 00               DB 0x0
[...]
```

We can attempt to dump possibly injected code from *svchost.exe*:

```bash
$ vol.py -f zeus.vmem --profile=WinXPSP2x86 -p 856 malfind -D dump/
Volatility Foundation Volatility Framework 2.5
Process: svchost.exe Pid: 856 Address: 0xb70000
Vad Tag: VadS Protection: PAGE_EXECUTE_READWRITE
Flags: CommitCharge: 38, MemCommit: 1, PrivateMemory: 1, Protection: 6

0x00b70000  4d 5a 90 00 03 00 00 00 04 00 00 00 ff ff 00 00   MZ..............
0x00b70010  b8 00 00 00 00 00 00 00 40 00 00 00 00 00 00 00   ........@.......
0x00b70020  00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00   ................
0x00b70030  00 00 00 00 00 00 00 00 00 00 00 00 d0 00 00 00   ................

0x00b70000 4d               DEC EBP
0x00b70001 5a               POP EDX

[...]
```

The *malfind* plugin will dump all possibly injected code in the inspected process. We can manually verify the dumped data for malicious behavior:

```bash
$ file dump/*
dump/process.0x80ff88d8.0xb70000.dmp: PE32 executable for MS Windows (GUI) Intel 80386 32-bit
dump/process.0x80ff88d8.0xcb0000.dmp: COM executable for DOS
```

We could verify and confirm that one of the dumped file indeed belongs to the malicious executable:

<center><img src='/images/zeus_VT.png'></center>

Finally, we enumerate various registry entries through which the malicious executable can run during system startup:

```bash
$ vol.py -f zeus.vmem --profile=WinXPSP2x86 printkey -K "Microsoft\\Windows NT\\CurrentVersion\\Winlogon"
Volatility Foundation Volatility Framework 2.5
Legend: (S) = Stable   (V) = Volatile

[...]

Registry: \Device\HarddiskVolume1\WINDOWS\system32\config\software
Key name: Winlogon (S)
Last updated: 2010-08-15 19:17:23 UTC+0000

Subkeys:
  (S) GPExtensions
  (S) Notify
  (S) SpecialAccounts
  (V) Credentials

Values:
REG_DWORD     AutoRestartShell : (S) 1
REG_SZ        DefaultDomainName : (S) BILLY-DB5B96DD3
REG_SZ        DefaultUserName : (S) Administrator
REG_SZ        LegalNoticeCaption : (S) 
REG_SZ        LegalNoticeText : (S) 
REG_SZ        PowerdownAfterShutdown : (S) 0
REG_SZ        ReportBootOk    : (S) 1
REG_SZ        Shell           : (S) Explorer.exe
REG_SZ        ShutdownWithoutLogon : (S) 0
REG_SZ        System          : (S) 
REG_SZ        Userinit        : (S) C:\WINDOWS\system32\userinit.exe,C:\WINDOWS\system32\sdra64.exe,
REG_SZ        VmApplet        : (S) rundll32 shell32,Control_RunDLL "sysdm.cpl"

```

We conclude that the *UserInit* registry entry has been modified with additional path to malicious executable *C:\WINDOWS\system32\sdra64.exe* through which it is executed during system startup.

