# RbWinDBG

*Win32 scriptable debugger in Ruby using Metasm API.*

**RbWinDBG** is a scriptable debugging written in *Ruby* programming language. It uses *Windows API* and *Metasm* library to provide an easy to use abstract interface to the Windows Debugging functionalities.

## Usage

Basic familiarity with Ruby programming language is required in order to use *RbWinDBG* effectively.

A script using *RbWinDBG* must load the library first and initialize it:

```ruby
require 'rbWinDBG'

RbWinDBG.init()
```

A debugger object can be created using the following code:

```ruby
dbg = RbWinDBG.start("C:\\Windows\\System32\\notepad.exe")
```

The above code initializes the RbWinDBG instance and internally creates the target process using [CreateProcess][1] API with [DEBUG_PROCESS][2] flag. This means that the target process is created in a suspended state till the debugger instructs the Operating System to continue execution of the process.

### Event Callbacks

Due to the nature of event driven interface of Windows Debugging APIs, RbWinDBG follows event driven programming paradigm. This means scripts using RbWinDBG must define callback code blocks (functions) that will be called when specific events occur in the debugee (target) process. 

#### Event: On Entrypoint

```ruby
dbg.on_entrypoint do
	...
end
```

#### Event: On Load Library

```ruby
dbg.on_library_load do |lib|
	...
end
```

#### Event: On Exception

```ruby
dbg.on_exception do |exception|
	...
end
```

#### Event: Breakpoint Callback

```ruby
dbg.bpx(addr) do 
	...
end
```

## Sample Debugger using RbWinDBG

```ruby
require 'RbWinDBG'

if __FILE__ == $0
    RbWinDBG.init()

    dbg = RbWinDBG.start("C:\\Windows\\System32\\notepad.exe")

    puts "Process Handle: 0x%08x" % [dbg.process.handle]
    puts "EP: 0x%08x" % [dbg.entrypoint]

    dbg.on_entrypoint do
        puts "Exe Path: " + dbg.process.modules[0].path
        puts "Current EIP: 0x%08x" % dbg.get_reg_value(:eip)

        puts 'Kernel32.DLL path: ' + dbg.resolve_lib_path('kernel32.dll')

        puts "CreateFileW: 0x%08x" % dbg.resolve_name('kernel32.dll!CreateFileW')
        puts "GetMessageA: 0x%08x" % dbg.resolve_name('user32.dll!GetMessageA')

        puts "VirtualAlloc(0x60): 0x%08x" % [dbg.virtual_alloc(0x60)]

        dbg.bpx(dbg.resolve_name('kernel32.dll!CreateFileW')) do
            puts 'CreateFileW: %s' % [dbg.utils.read_wstring(dbg.utils.ptr_at(dbg.get_reg_value(:esp) + 4))]
        end 

        dbg.on_library_load do |lib|
            puts 'LoadLibrary: ' + lib.to_s
        end

        dbg.on_exception do |ei|
            puts "Process Exception: #{ei[:type]}"
        end

        dbg.on_thread_start do |ei|
            puts "New Thread Created #{ei.inspect}"
        end

        dbg.on_thread_exit do |ei|
            puts "Thread Exit #{ei.inspect}"
        end
    end

    dbg.start
end
```

This sample can be run using the following command, assuming RbWinDBG is available in current directory and the script is in samples\BasicTest.rb:

```
ruby -I . samples\BasicTest.rb
```

![RbWinDBG Sample](../../images/rbwindbg_sample.png "RbWinDBG Sample")



# Reference

* [Ruby - Pragmatic Programmers Guide](http://ruby-doc.com/docs/ProgrammingRuby/)
* [RbWinDBG GIT](https://github.com/abhisek/RandomCode/tree/master/RbWinDBG)


[1]: <https://msdn.microsoft.com/en-us/library/windows/desktop/ms682425(v=vs.85).aspx>

[2]: https://msdn.microsoft.com/en-us/library/windows/desktop/ms684863(v=vs.85).aspx

