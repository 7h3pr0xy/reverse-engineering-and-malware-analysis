# Dynamic Malware Analysis

Dynamic malware analysis is the process of running a malicious sample in a *contained* environment while observing its various behavioural activity. This can be as simple as running a malicious sample in a virtual machine with [Procmon](https://technet.microsoft.com/en-us/sysinternals/processmonitor.aspx) or as complex as building a custom container with kernel mode instrumentation for logging behavioural activity of a given sample.

## Containment

Malware analysis environment must ensure that it is segregated from other network and systems. Any malware activity must be contained within the analysis environment. For this reason, it is important to setup a sandbox or VM based contained environment that can be easily configured to emulate required platform.

## Malware Analysis with Sandboxie and Fakenet

[Sandboxie](http://www.sandboxie.com/) is a user space sandboxing tool for applications. It can be used to contain all file system changes by a sandboxed application within the sandbox to prevent any actual change in the operating system. Sandboxie provides the required containment for malware analysis purpose. Along with [Buster Sandbox Analyzer](http://bsa.isoftware.nl/), a user mode dynamic malware analysis environment can be setup easily. For network access simulation within our contained environment, we will use the [Fakenet](https://practicalmalwareanalysis.com/fakenet/) program.

### Installation

* Install Sandboxie
* Install BSA by extracting provided *rar* to C:\BSA
* Copy LOG_API.DLL from architecture specific directory to *C:\BSA\LOG_API.DLL*
	* Copy C:\BSA\LOG_API\32\LOG_API.DLL to C:\BSA\LOG_API.DLL
* Edit Sandboxie configuration file to create a new sandbox configuration:

```
[BSABOX]

Enabled=y
ConfigLevel=7
BorderColor=#00FFFF,off
InjectDll=C:\BSA\LOG_API.DLL
OpenWinClass=TFormBSA
NotifyDirectDiskAccess=y
ProcessLimit1=20
ProcessLimit2=30
SbieCtrl_HideMessage=*
BoxNameTitle=n
CopyLimitKb=102400
CopyLimitSilent=y
```

* Run notepad.exe in the new sandbox to initialise directory structure
* Copy path to new sandbox directory to BSA

<center><img src='../../images/sandboxie_bsa.png'></img></center>

### Workflow

* Run Sandboxie
* Run BSA
* Start BSA Analysis
* Run Fakenet
* Run Sample in BSA configured Sandbox

<center><img src='../../images/sandboxie_bsa_fakenet.png'></img></center>

## Malware Analysis with Cuckoo Sandbox

The [Cuckoo Sandbox](https://github.com/cuckoosandbox/cuckoo) provides an automated analysis environment for malware analysis. It can use [VirtualBox]() or [VMware]() as the virtual environment to run malware samples while tracing its behaviour.



